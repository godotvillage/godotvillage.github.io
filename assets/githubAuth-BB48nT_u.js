class i{constructor(){this.clientId="Ov23liJJhJJJJJJJJJJJ",this.redirectUri=window.location.origin+"/auth/callback",this.storageKey="github_user",this.tokenKey="github_token"}getCurrentUser(){try{const t=localStorage.getItem(this.storageKey);return t?JSON.parse(t):null}catch(t){return console.error("获取用户信息失败:",t),null}}getAccessToken(){return localStorage.getItem(this.tokenKey)}isLoggedIn(){return!!this.getCurrentUser()&&!!this.getAccessToken()}login(){const t=this.generateState();localStorage.setItem("oauth_state",t);const e=new URLSearchParams({client_id:this.clientId,redirect_uri:this.redirectUri,scope:"read:user user:email",state:t,allow_signup:"true"});window.location.href=`https://github.com/login/oauth/authorize?${e.toString()}`}async handleCallback(t,e){try{const o=localStorage.getItem("oauth_state");if(e!==o)throw new Error("Invalid state parameter");localStorage.removeItem("oauth_state");const r=await fetch("/api/auth/github/callback",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:t})});if(!r.ok)throw new Error("Failed to exchange code for token");const{access_token:a}=await r.json(),n=await this.fetchUserInfo(a);return localStorage.setItem(this.tokenKey,a),localStorage.setItem(this.storageKey,JSON.stringify(n)),n}catch(o){throw console.error("GitHub登录失败:",o),o}}async fetchUserInfo(t){try{const e=await fetch("https://api.github.com/user",{headers:{Authorization:`token ${t}`,Accept:"application/vnd.github.v3+json"}});if(!e.ok)throw new Error("Failed to fetch user info");const o=await e.json();return{id:o.id,login:o.login,name:o.name,email:o.email,avatar_url:o.avatar_url,html_url:o.html_url}}catch(e){throw console.error("获取用户信息失败:",e),e}}logout(){localStorage.removeItem(this.storageKey),localStorage.removeItem(this.tokenKey),localStorage.removeItem("oauth_state")}isProjectAuthor(t,e=null){return e||(e=this.getCurrentUser()),!e||!t?!1:t.author===e.login||t.author===e.name||t.githubUser&&t.githubUser===e.login}generateState(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}mockLogin(t){const e={id:Date.now(),login:t,name:t,email:`${t}@example.com`,avatar_url:`https://github.com/${t}.png`,html_url:`https://github.com/${t}`};return localStorage.setItem(this.storageKey,JSON.stringify(e)),localStorage.setItem(this.tokenKey,"mock_token_"+Date.now()),e}}const l=new i;export{l as g};
